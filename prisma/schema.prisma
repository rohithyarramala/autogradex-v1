generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id                     String                 @id @default(uuid())
  name                   String
  email                  String                 @unique
  // optional roll number for students
  rollNo                 String?
  emailVerified          DateTime?
  password               String?
  image                  String?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @default(now())
  invalid_login_attempts Int                    @default(0)
  lockedAt               DateTime?
  accounts               Account[]
  Evaluation             Evaluation[]
  EvaluationSubmissions  EvaluationSubmission[]
  invitations            Invitation[]
  organizationMember     OrganizationMember[]
  sessions               Session[]
  studentEnrollments     StudentEnrollment[]
  teachingSubjects       Subject[]
}

model Organization {
  id              String               @id @default(uuid())
  name            String
  slug            String               @unique
  domain          String?              @unique
  defaultRole     Role                 @default(ADMIN)
  billingId       String?
  billingProvider String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @default(now())
  apiKeys         ApiKey[]
  classes         Class[]
  invitations     Invitation[]
  members         OrganizationMember[]

  trialEndsAt        DateTime?
  subscriptionId     String? // current RZP subscription id
  planId             String? // current Razorpay plan
  nextPlanId         String? // selected downgrade plan (optional)
  subscriptionStatus String?   @default("inactive")

  usage Usage?
  currentUsageId   String?


  sections      Section[]
  subjects      Subject[]
  evaluations   Evaluation[]
  subscriptions Subscription[] // <-- Added relation field

  @@index([billingId])
}

model OrganizationMember {
  id             String       @id @default(uuid())
  organizationId String
  userId         String
  role           Role         @default(TEACHER)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
}

model Invitation {
  id             String       @id @default(uuid())
  organizationId String
  email          String?
  role           Role         @default(TEACHER)
  token          String       @unique
  expires        DateTime
  invitedBy      String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now())
  sentViaEmail   Boolean      @default(true)
  allowedDomains String[]     @default([])
  user           User         @relation(fields: [invitedBy], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@index([email])
}

model PasswordReset {
  id        Int      @id @default(autoincrement())
  email     String
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  expiresAt DateTime
}

model ApiKey {
  id             String       @id @default(uuid())
  name           String
  organizationId String
  hashedKey      String       @unique
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now())
  expiresAt      DateTime?
  lastUsedAt     DateTime?
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// model Subscription {
//   id         String    @id
//   customerId String
//   priceId    String
//   active     Boolean   @default(false)
//   startDate  DateTime
//   endDate    DateTime
//   cancelAt   DateTime?
//   createdAt  DateTime  @default(now())
//   updatedAt  DateTime  @default(now())

//   @@index([customerId])
// }

model Subscription {
  id             String    @id // razorpay subscription id
  organizationId String
  planId         String
  status         String    @default("created") // created | authenticated | active | pending | halted | cancelled
  currentStart   DateTime?
  currentEnd     DateTime?
  notes          Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// Add limits JSON option to Service
model Service {
  id          String   @id @default(uuid())
  name        String
  description String
  features    String[]
  image       String
  created     DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
  Price       Price[]
  limits      Json? // e.g. {"maxTeachers":2,"maxAIEvaluationsPerMonth":500}
}


model ServicePlan {
  id          String   @id @default(uuid())
  name        String   @unique
  rzpPlanId   String   @unique
  price       Int
  limits      Json
  createdAt   DateTime @default(now())
}


// model Service {
//   id          String   @id @default(uuid())
//   description String
//   features    String[]
//   image       String
//   name        String
//   created     DateTime
//   createdAt   DateTime @default(now())
//   updatedAt   DateTime @default(now())
//   Price       Price[]
// }

// New Usage model (monthly usage bucket)
model Usage {
  id                String   @id @default(uuid())
  organizationId    String   @unique
  periodStart       DateTime
  periodEnd         DateTime
  usedTeachers      Int      @default(0)
  usedStudents      Int      @default(0)
  usedEvaluations   Int      @default(0)
  usedAIEvaluations Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, periodStart])
  @@index([organizationId])
}

model Price {
  id            String   @id @default(uuid())
  billingScheme String
  currency      String
  serviceId     String
  amount        Int?
  metadata      Json
  type          String
  created       DateTime
  service       Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
}

model Class {
  id             String              @id @default(uuid())
  name           String
  organizationId String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @default(now())
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  evaluation     Evaluation[]
  sections       Section[]
  students       StudentEnrollment[]
}

model Section {
  id             String              @id @default(uuid())
  name           String
  classId        String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @default(now())
  organizationId String
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  evaluation     Evaluation[]
  class          Class?              @relation(fields: [classId], references: [id], onDelete: Cascade)
  students       StudentEnrollment[]
  subjects       Subject[]
}

model StudentEnrollment {
  id        String   @id @default(uuid())
  studentId String
  sectionId String
  classId   String
  createdAt DateTime @default(now())
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  section   Section  @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  student   User     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, sectionId])
}

model Subject {
  id             String       @id @default(uuid())
  name           String
  desc           String
  sectionId      String?
  teacherId      String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now())
  evaluation     Evaluation[]
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  section        Section?     @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  teacher        User         @relation(fields: [teacherId], references: [id], onDelete: Cascade)
}

model Evaluation {
  id               String                 @id @default(uuid())
  name             String
  classId          String
  sectionId        String
  subjectId        String
  createdBy        String
  maxMarks         Int
  status           String                 @default("rubrics-not-generated") // rubrics not generated, upload pending, ready for evaluation, evaluating, evaluated
  uploadedBy       String                 @default("student")
  rubrics          Json?
  rubricsGenerated Boolean?
  organizationId   String
  org              Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  questionPdf      String
  answerKey        String?
  createdAt        DateTime               @default(now())
  class            Class                  @relation(fields: [classId], references: [id], onDelete: Cascade)
  creator          User                   @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  section          Section                @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  subject          Subject                @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  submissions      EvaluationSubmission[]
}

model EvaluationSubmission {
  id           String   @id @default(uuid())
  evaluationId String
  studentId    String
  scriptPdf    String?
  totalMark    Int?
  status       String   @default("not-uploaded") // not uploaded, uploaded, evaluating, evaluated, failed, skipped
  feedback     String?
  aiResult     Json?
  isAbsent     Boolean  @default(false)
  createdAt    DateTime @default(now())

  EvaluationResult EvaluationResult[]
  evaluation       Evaluation         @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  student          User               @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model jackson_store {
  key           String          @id(map: "_jackson_store_key") @db.VarChar(1500)
  value         String
  iv            String?         @db.VarChar(64)
  tag           String?         @db.VarChar(64)
  createdAt     DateTime        @default(now()) @db.Timestamp(6)
  modifiedAt    DateTime?       @db.Timestamp(6)
  namespace     String?         @db.VarChar(256)
  jackson_index jackson_index[]

  @@index([namespace], map: "_jackson_store_namespace")
  @@ignore
}

model jackson_index {
  id       Int           @id(map: "_jackson_index_id") @default(autoincrement())
  key      String        @db.VarChar(1500)
  storeKey String        @db.VarChar(1500)
  store    jackson_store @relation(fields: [storeKey], references: [key], onDelete: Cascade, onUpdate: NoAction)

  @@index([key], map: "_jackson_index_key")
  @@index([key, storeKey], map: "_jackson_index_key_store")
  @@ignore
}

model jackson_ttl {
  key       String @id(map: "jackson_ttl_key") @db.VarChar(1500)
  expiresAt BigInt

  @@index([expiresAt], map: "_jackson_ttl_expires_at")
  @@ignore
}

model EvaluationResult {
  id                   String               @id
  submissionId         String
  questionNo           Int
  questionText         String
  maxMark              Int
  aiMark               Int?
  teacherMark          Int?
  feedback             String?
  createdAt            DateTime             @default(now())
  EvaluationSubmission EvaluationSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  // status String @default("submitted")
  @@unique([submissionId, questionNo])
}

enum Role {
  SUPER_ADMIN
  ADMIN
  TEACHER
  STUDENT
}
